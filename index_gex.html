<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GEX HTML Archive Viewer</title>

  <style>
    :root {
      --bg0: #0b0f14;
      --bg1: #111826;
      --bg2: #182235;
      --text0: #e6edf3;
      --text1: #94a3b8;
      --border: rgba(148, 163, 184, 0.18);
      --accent: #4cc9f0;
      --accent2: #b5179e;
      --danger: #f87171;
      --ok: #34d399;
      --warn: #fbbf24;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --topbar-h: 48px;
      --sidebar-w: 260px;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: radial-gradient(1200px 800px at 20% 20%, rgba(76, 201, 240, 0.10), transparent 55%),
                  radial-gradient(1200px 800px at 80% 80%, rgba(181, 23, 158, 0.08), transparent 55%),
                  var(--bg0);
      color: var(--text0);
      font-family: var(--sans);
      overflow: hidden;
    }

    .app {
      height: 100%;
      display: grid;
      grid-template-columns: var(--sidebar-w) 1fr;
      gap: 10px;
      padding: 10px;
      min-height: 0;
    }

    .sidebar {
      background: linear-gradient(180deg, rgba(17, 24, 38, 0.98), rgba(17, 24, 38, 0.92));
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-width: 200px;
      min-height: 0;
    }

    .sidebarHeader {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .title {
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.2px;
      line-height: 1.1;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .folderDisplay {
      font-size: 10px;
      color: var(--text1);
      font-family: var(--mono);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding: 4px 0;
    }
    .folderDisplay.hasFolder {
      color: var(--ok);
    }

    .btn {
      appearance: none;
      border: 1px solid var(--border);
      background: rgba(24, 34, 53, 0.8);
      color: var(--text0);
      border-radius: 8px;
      padding: 6px 8px;
      font-size: 11px;
      cursor: pointer;
      transition: transform 0.15s ease, border-color 0.15s ease, background 0.15s ease;
      user-select: none;
    }
    .btn:hover { border-color: rgba(76, 201, 240, 0.45); transform: translateY(-1px); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btnPrimary {
      border-color: rgba(76, 201, 240, 0.40);
      background: linear-gradient(135deg, rgba(76, 201, 240, 0.22), rgba(181, 23, 158, 0.14));
    }
    .btnSmall {
      padding: 4px 6px;
      font-size: 10px;
    }

    .btnTicker {
      padding: 3px 8px;
      font-size: 10px;
      font-family: var(--mono);
      border-radius: 12px;
      background: rgba(24, 34, 53, 0.6);
      border: 1px solid var(--border);
      color: var(--text0);
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .btnTicker:hover {
      border-color: var(--accent);
      background: rgba(76, 201, 240, 0.15);
    }
    .btnTicker.active {
      border-color: var(--accent);
      background: rgba(76, 201, 240, 0.25);
      color: var(--accent);
    }
    .btnTicker.unavailable {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .btnTicker.unavailable:hover {
      border-color: var(--border);
      background: rgba(24, 34, 53, 0.6);
    }

    .controls {
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow-y: auto;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    label {
      font-size: 10px;
      color: var(--text1);
    }

    select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: rgba(24, 34, 53, 0.65);
      color: var(--text0);
      font-size: 11px;
      font-family: var(--mono);
      outline: none;
    }
    select:focus {
      border-color: rgba(76, 201, 240, 0.55);
      box-shadow: 0 0 0 3px rgba(76, 201, 240, 0.12);
    }

    .recentTickers {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 2px;
    }
    .recentTickersLabel {
      font-size: 9px;
      color: var(--text1);
      width: 100%;
      margin-bottom: 2px;
    }

    .main {
      background: linear-gradient(180deg, rgba(17, 24, 38, 0.92), rgba(17, 24, 38, 0.78));
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      display: grid;
      grid-template-rows: var(--topbar-h) 1fr;
      min-width: 320px;
      min-height: 0;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      background: rgba(24, 34, 53, 0.35);
    }

    .status {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text1);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 0;
    }

    .actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .viewer {
      min-height: 0;
      background: rgba(11, 15, 20, 0.35);
      position: relative;
    }

    .loadingOverlay {
      position: absolute;
      inset: 0;
      background: rgba(11, 15, 20, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.1s ease;
    }
    .loadingOverlay.show {
      opacity: 1;
      pointer-events: auto;
    }
    .loadingOverlay span {
      font-family: var(--mono);
      font-size: 14px;
      color: var(--accent);
    }

    iframe {
      width: 100%;
      height: 100%;
      border: 0;
      background: #ffffff;
    }

    .hint {
      font-family: var(--mono);
      font-size: 10px;
      color: var(--text1);
      line-height: 1.4;
      padding: 6px 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 4px;
    }
    .hint kbd {
      font-family: var(--mono);
      font-size: 9px;
      padding: 1px 4px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: rgba(24, 34, 53, 0.55);
      color: var(--text0);
    }

    .progressBar {
      height: 3px;
      background: var(--bg2);
      border-radius: 2px;
      overflow: hidden;
      margin-top: 4px;
    }
    .progressBar .fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      width: 0%;
      transition: width 0.1s ease;
    }

    .infoBox {
      background: rgba(24, 34, 53, 0.5);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px;
      font-family: var(--mono);
      font-size: 10px;
      color: var(--text1);
      display: grid;
      gap: 2px;
    }
    .infoBox .label { color: var(--text1); }
    .infoBox .value { color: var(--text0); margin-left: 4px; }

    /* collapsed sidebar */
    body.sidebarCollapsed .app { grid-template-columns: 1fr; }
    body.sidebarCollapsed .sidebar { display: none; }
    body.sidebarCollapsed .main { min-width: 0; }

    @media (max-width: 800px) {
      .app { grid-template-columns: 1fr; }
      .sidebar { order: 2; min-width: 0; }
      .main { order: 1; }
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sidebarHeader">
        <div class="title">GEX Archive Viewer</div>
        <button class="btn btnSmall" id="collapseBtn" title="Êî∂ÂêàÂÅ¥Ê¨Ñ">Êî∂Âêà</button>
      </div>

      <div class="controls">
        <input id="dirInput" type="file" webkitdirectory multiple style="display:none" />

        <div style="display:flex; gap:6px;">
          <button class="btn btnPrimary" id="pickFolderBtn">ÈÅ∏ÊìáË≥áÊñôÂ§æ</button>
          <button class="btn" id="rescanBtn" title="ÈáçÊñ∞ÊéÉÊèèË≥áÊñôÂ§æ‰ª•ËºâÂÖ•Êñ∞Â¢ûÁöÑÊ™îÊ°à" disabled>ÈáçÊñ∞ÊéÉÊèèÊñ∞Â¢ûÊ™îÊ°à</button>
        </div>
        <div class="folderDisplay" id="folderLabel">Â∞öÊú™ÈÅ∏ÊìáË≥áÊñôÂ§æ</div>

        <div id="scanProgress" style="display:none;">
          <div style="font-size:10px; color:var(--text1);" id="scanProgressText">ÊéÉÊèè‰∏≠...</div>
          <div class="progressBar"><div class="fill" id="scanProgressFill"></div></div>
        </div>

        <div class="field">
          <label for="tickerSel">Ticker</label>
          <select id="tickerSel"></select>
          <div class="recentTickers" id="recentTickers"></div>
        </div>

        <div class="row">
          <div class="field">
            <label for="dateSel">Ë∑≥Âà∞Êó•Êúü</label>
            <select id="dateSel"></select>
          </div>
          <div class="field">
            <label for="featureSel">Ë∑≥Âà∞ÂäüËÉΩ</label>
            <select id="featureSel"></select>
          </div>
        </div>

        <div class="hint">
          <kbd>‚Üë</kbd>/<kbd>‚Üì</kbd> ‰∏ä/‰∏ã‰∏ÄÂÄã„ÄÄ<kbd>‚Üê</kbd>/<kbd>‚Üí</kbd> ÂàáÊèõÂäüËÉΩ
        </div>

        <div class="infoBox" id="currentInfo" style="display:none;">
          <div><span class="label">ÁõÆÂâçÔºö</span><span class="value" id="infoDate">-</span></div>
          <div><span class="label">ÂäüËÉΩÔºö</span><span class="value" id="infoFeature">-</span></div>
          <div><span class="label">‰ΩçÁΩÆÔºö</span><span class="value" id="infoIndex">-</span></div>
        </div>
      </div>
    </aside>

    <main class="main" id="mainPanel">
      <div class="topbar">
        <div class="status" id="statusText">Ë´ãÂÖàÊåâ„ÄåÈÅ∏ÊìáË≥áÊñôÂ§æ„ÄçËºâÂÖ• HTML Â≠òÊ™î„ÄÇ</div>
        <div class="actions">
          <button class="btn btnSmall" id="toggleSidebarBtn" title="Êî∂Âêà/Â±ïÈñãÂÅ¥Ê¨Ñ">Êî∂ÂêàÂÅ¥Ê¨Ñ</button>
          <button class="btn btnSmall" id="openNewTabBtn" title="Áî®Êñ∞ÂàÜÈ†ÅÈñãÂïüÁõÆÂâçÊ™îÊ°à" disabled>Êñ∞ÂàÜÈ†Å</button>
          <button class="btn btnSmall" id="fullscreenBtn" title="ÂÖ®Ëû¢Âπï" disabled>ÂÖ®Ëû¢Âπï</button>
        </div>
      </div>
      <div class="viewer">
        <div class="loadingOverlay" id="loadingOverlay"><span>ËºâÂÖ•‰∏≠...</span></div>
        <iframe id="viewerFrame" title="HTML Viewer"></iframe>
      </div>
    </main>
  </div>

  <script>
    // -----------------------------
    // State
    // -----------------------------
    const state = {
      files: [],
      filtered: [],
      activeIndex: -1,
      activeObjectUrl: null,
      newTabBlobUrl: null,
      folderDisplayName: "",
      lastDirHandle: null,
      tickerSelected: false,
      scrollPosition: { x: 0, y: 0 },
      hasFolderSelected: false,
      recentTickers: [],
    };

    const RECENT_TICKERS_KEY = 'gex_recent_tickers';
    const MAX_RECENT_TICKERS = 10;

    // -----------------------------
    // DOM
    // -----------------------------
    const el = {
      dirInput: document.getElementById('dirInput'),
      pickFolderBtn: document.getElementById('pickFolderBtn'),
      rescanBtn: document.getElementById('rescanBtn'),
      folderLabel: document.getElementById('folderLabel'),
      dateSel: document.getElementById('dateSel'),
      tickerSel: document.getElementById('tickerSel'),
      featureSel: document.getElementById('featureSel'),
      viewerFrame: document.getElementById('viewerFrame'),
      statusText: document.getElementById('statusText'),
      collapseBtn: document.getElementById('collapseBtn'),
      toggleSidebarBtn: document.getElementById('toggleSidebarBtn'),
      fullscreenBtn: document.getElementById('fullscreenBtn'),
      openNewTabBtn: document.getElementById('openNewTabBtn'),
      loadingOverlay: document.getElementById('loadingOverlay'),
      scanProgress: document.getElementById('scanProgress'),
      scanProgressText: document.getElementById('scanProgressText'),
      scanProgressFill: document.getElementById('scanProgressFill'),
      currentInfo: document.getElementById('currentInfo'),
      infoDate: document.getElementById('infoDate'),
      infoFeature: document.getElementById('infoFeature'),
      infoIndex: document.getElementById('infoIndex'),
      recentTickers: document.getElementById('recentTickers'),
    };

    // -----------------------------
    // Helpers
    // -----------------------------
    function escapeHtml(s) {
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function normalizeTime(raw) {
      return raw.replace(';', ':');
    }

    function parseRecordFromFileLike({ file, relPath, name }) {
      const m = name.match(/^(\d{4}-\d{2}-\d{2})_(\d{2}[;:]\d{2})_([A-Za-z0-9]+)_(.+)\.html$/i);
      if (!m) return null;

      const date = m[1];
      const time = normalizeTime(m[2]);
      const ticker = m[3].toUpperCase();
      const feature = m[4];
      const dt = new Date(`${date}T${time}:00`);
      const ts = Number.isFinite(dt.getTime()) ? dt.getTime() : null;
      if (ts === null) return null;

      return { file, relPath, name, date, time, ticker, feature, ts };
    }

    function setStatus(text, kind = "info") {
      const prefix = kind === "error" ? "‚úó " : kind === "ok" ? "‚úì " : "‚Ä¢ ";
      el.statusText.textContent = `${prefix}${text}`;
    }

    function updatePageTitle(record) {
      if (record) {
        document.title = `${record.ticker} ${record.date} ${record.time} ${record.feature} - GEX Viewer`;
      } else {
        document.title = 'GEX HTML Archive Viewer';
      }
    }

    function updateFolderDisplay() {
      if (state.hasFolderSelected && state.folderDisplayName) {
        el.folderLabel.textContent = `üìÅ ${state.folderDisplayName}`;
        el.folderLabel.classList.add('hasFolder');
        el.pickFolderBtn.textContent = 'Êõ¥ÊèõË≥áÊñôÂ§æ';
      } else {
        el.folderLabel.textContent = 'Â∞öÊú™ÈÅ∏ÊìáË≥áÊñôÂ§æ';
        el.folderLabel.classList.remove('hasFolder');
        el.pickFolderBtn.textContent = 'ÈÅ∏ÊìáË≥áÊñôÂ§æ';
      }
    }

    function fillSelect(selectEl, values, { placeholder = null } = {}) {
      const curr = selectEl.value;
      const opts = [];
      if (placeholder) opts.push({ value: "__PLACEHOLDER__", label: placeholder, disabled: true });
      for (const v of values) opts.push({ value: v, label: v });
      selectEl.innerHTML = opts.map(o => 
        `<option value="${escapeHtml(o.value)}" ${o.disabled ? 'disabled' : ''}>${escapeHtml(o.label)}</option>`
      ).join('');
      if (opts.some(o => o.value === curr && !o.disabled)) selectEl.value = curr;
      else if (placeholder) selectEl.value = "__PLACEHOLDER__";
      else selectEl.value = values[0] ?? "";
    }

    function getSelectedTicker() {
      const v = el.tickerSel.value;
      if (v === "__PLACEHOLDER__") return null;
      return v;
    }

    function getFilteredByTicker() {
      const ticker = getSelectedTicker();
      if (!ticker) return [];
      return state.files
        .filter(r => r.ticker === ticker)
        .sort((a, b) => b.ts - a.ts || a.relPath.localeCompare(b.relPath));
    }

    function isTypingContext() {
      const a = document.activeElement;
      if (!a) return false;
      const tag = a.tagName;
      return tag === 'INPUT' || tag === 'TEXTAREA' || a.isContentEditable;
    }

    function showLoading(show) {
      if (show) el.loadingOverlay.classList.add('show');
      else el.loadingOverlay.classList.remove('show');
    }

    function saveScrollPosition() {
      try {
        const iframeWin = el.viewerFrame.contentWindow;
        if (iframeWin) {
          state.scrollPosition.x = iframeWin.scrollX || 0;
          state.scrollPosition.y = iframeWin.scrollY || 0;
        }
      } catch (e) {
        // Cross-origin or not loaded yet - ignore
      }
    }

    function restoreScrollPosition() {
      // Wait a bit for Plotly to render
      setTimeout(() => {
        try {
          const iframeWin = el.viewerFrame.contentWindow;
          if (iframeWin) {
            iframeWin.scrollTo(state.scrollPosition.x, state.scrollPosition.y);
          }
        } catch (e) {
          // Cross-origin or not loaded yet - ignore
        }
      }, 150);
    }

    // -----------------------------
    // Recent Tickers
    // -----------------------------
    function loadRecentTickers() {
      try {
        const saved = localStorage.getItem(RECENT_TICKERS_KEY);
        if (saved) {
          state.recentTickers = JSON.parse(saved);
        }
      } catch (e) {
        state.recentTickers = [];
      }
    }

    function saveRecentTickers() {
      try {
        localStorage.setItem(RECENT_TICKERS_KEY, JSON.stringify(state.recentTickers));
      } catch (e) {
        // ignore
      }
    }

    function addRecentTicker(ticker) {
      if (!ticker) return;
      // Remove if exists
      state.recentTickers = state.recentTickers.filter(t => t !== ticker);
      // Add to front
      state.recentTickers.unshift(ticker);
      // Keep only MAX
      if (state.recentTickers.length > MAX_RECENT_TICKERS) {
        state.recentTickers = state.recentTickers.slice(0, MAX_RECENT_TICKERS);
      }
      saveRecentTickers();
      renderRecentTickers();
    }

    function renderRecentTickers() {
      if (state.recentTickers.length === 0) {
        el.recentTickers.innerHTML = '';
        return;
      }

      const availableTickers = new Set(state.files.map(r => r.ticker));
      const hasFiles = state.files.length > 0;
      const currentTicker = getSelectedTicker();

      el.recentTickers.innerHTML = `
        <div class="recentTickersLabel">Â∏∏Áî®Ôºö</div>
        ${state.recentTickers.map(t => {
          const isAvailable = !hasFiles || availableTickers.has(t);
          const isActive = t === currentTicker;
          const classes = ['btnTicker'];
          if (isActive) classes.push('active');
          if (hasFiles && !availableTickers.has(t)) classes.push('unavailable');
          return `<button class="${classes.join(' ')}" data-ticker="${escapeHtml(t)}" ${!isAvailable ? 'title="Ê≠§ Ticker ‰∏çÂ≠òÂú®ÊñºÁõÆÂâçË≥áÊñôÂ§æ"' : ''}>${escapeHtml(t)}</button>`;
        }).join('')}
      `;

      // Add click handlers
      el.recentTickers.querySelectorAll('.btnTicker').forEach(btn => {
        btn.addEventListener('click', () => {
          const ticker = btn.dataset.ticker;
          if (!ticker) return;
          
          // If no files loaded yet, just remember the selection
          if (state.files.length === 0) {
            setStatus('Ë´ãÂÖàÈÅ∏ÊìáË≥áÊñôÂ§æËºâÂÖ•Ê™îÊ°à„ÄÇ', 'info');
            return;
          }
          
          // Check if ticker exists in current files
          const availableTickers = new Set(state.files.map(r => r.ticker));
          if (!availableTickers.has(ticker)) {
            setStatus(`Ticker "${ticker}" ‰∏çÂ≠òÂú®ÊñºÁõÆÂâçË≥áÊñôÂ§æ„ÄÇ`, 'error');
            return;
          }
          
          el.tickerSel.value = ticker;
          onTickerChange();
        });
      });
    }

    // -----------------------------
    // UI Updates
    // -----------------------------
    function updateCurrentInfo() {
      if (!state.tickerSelected || state.filtered.length === 0 || state.activeIndex < 0) {
        el.currentInfo.style.display = 'none';
        return;
      }

      const r = state.filtered[state.activeIndex];
      if (!r) {
        el.currentInfo.style.display = 'none';
        return;
      }

      el.currentInfo.style.display = 'grid';
      el.infoDate.textContent = `${r.date} ${r.time}`;
      el.infoFeature.textContent = r.feature;
      el.infoIndex.textContent = `${state.activeIndex + 1} / ${state.filtered.length}`;
    }

    function updateTopStatus() {
      if (!state.tickerSelected) {
        setStatus('Ë´ãÈÅ∏Êìá Ticker ÈñãÂßãÁÄèË¶Ω„ÄÇ', 'info');
        el.openNewTabBtn.disabled = true;
        el.fullscreenBtn.disabled = true;
        updatePageTitle(null);
        return;
      }

      if (state.filtered.length === 0) {
        setStatus('Â∞öÁÑ°ÂèØÈ°ØÁ§∫È†ÖÁõÆ„ÄÇ', 'info');
        el.openNewTabBtn.disabled = true;
        el.fullscreenBtn.disabled = true;
        updatePageTitle(null);
        return;
      }

      const r = state.filtered[state.activeIndex] || null;
      if (!r) {
        setStatus(`ÂÖ± ${state.filtered.length} Á≠Ü`, 'info');
        el.openNewTabBtn.disabled = true;
        el.fullscreenBtn.disabled = true;
        updatePageTitle(null);
        return;
      }

      setStatus(`${r.date} ${r.time} ¬∑ ${r.feature} ¬∑ ${state.activeIndex + 1}/${state.filtered.length}`, 'ok');
      el.openNewTabBtn.disabled = false;
      el.fullscreenBtn.disabled = false;
      updatePageTitle(r);
    }

    // -----------------------------
    // Actions
    // -----------------------------
    function rebuildTickerSelector() {
      const tickers = Array.from(new Set(state.files.map(r => r.ticker))).sort((a, b) => a.localeCompare(b));
      fillSelect(el.tickerSel, tickers, { placeholder: "-- Ë´ãÈÅ∏Êìá --" });
      el.tickerSel.value = "__PLACEHOLDER__";
      state.tickerSelected = false;
      renderRecentTickers();
    }

    function rebuildDateAndFeatureSelectors() {
      const dates = Array.from(new Set(state.filtered.map(r => r.date))).sort((a, b) => b.localeCompare(a));
      const features = Array.from(new Set(state.filtered.map(r => r.feature))).sort((a, b) => a.localeCompare(b));
      fillSelect(el.dateSel, dates, { placeholder: "-- ÈÅ∏Êìá --" });
      fillSelect(el.featureSel, features, { placeholder: "-- ÈÅ∏Êìá --" });
    }

    function onTickerChange() {
      const ticker = getSelectedTicker();
      state.tickerSelected = !!ticker;
      state.filtered = getFilteredByTicker();
      state.activeIndex = -1;

      // Add to recent tickers
      if (ticker) {
        addRecentTicker(ticker);
      }

      rebuildDateAndFeatureSelectors();

      if (state.tickerSelected && state.filtered.length > 0) {
        state.activeIndex = 0;
        // Reset scroll position for new ticker
        state.scrollPosition = { x: 0, y: 0 };
        openActive();
      } else {
        clearViewer();
      }

      updateCurrentInfo();
      updateTopStatus();
      renderRecentTickers();

      // Blur to allow keyboard navigation
      el.tickerSel.blur();
    }

    function jumpToDate() {
      const date = el.dateSel.value;
      if (date === "__PLACEHOLDER__" || !state.tickerSelected) return;

      const idx = state.filtered.findIndex(r => r.date === date);
      if (idx !== -1 && idx !== state.activeIndex) {
        setActiveIndexFast(idx);
      }

      // Blur to allow keyboard navigation
      el.dateSel.blur();
    }

    function jumpToFeature() {
      const feature = el.featureSel.value;
      if (feature === "__PLACEHOLDER__" || !state.tickerSelected) return;

      const currRecord = state.filtered[state.activeIndex];
      let idx = -1;

      if (currRecord) {
        idx = state.filtered.findIndex(r => r.date === currRecord.date && r.time === currRecord.time && r.feature === feature);
        if (idx === -1) {
          idx = state.filtered.findIndex(r => r.date === currRecord.date && r.feature === feature);
        }
      }

      if (idx === -1) {
        idx = state.filtered.findIndex(r => r.feature === feature);
      }

      if (idx !== -1 && idx !== state.activeIndex) {
        setActiveIndexFast(idx);
      }

      // Blur to allow keyboard navigation
      el.featureSel.blur();
    }

    function clearViewer() {
      if (state.activeObjectUrl) {
        URL.revokeObjectURL(state.activeObjectUrl);
        state.activeObjectUrl = null;
      }
      el.viewerFrame.removeAttribute('src');
      el.viewerFrame.removeAttribute('srcdoc');
      el.viewerFrame.style.background = '#ffffff';
      el.openNewTabBtn.disabled = true;
      el.fullscreenBtn.disabled = true;
      showLoading(false);
    }

    function openRecord(record) {
      // Save current scroll position before loading new content
      saveScrollPosition();

      if (state.activeObjectUrl) {
        URL.revokeObjectURL(state.activeObjectUrl);
        state.activeObjectUrl = null;
      }

      try {
        const url = URL.createObjectURL(record.file);
        state.activeObjectUrl = url;

        // Set up onload handler to restore scroll position
        el.viewerFrame.onload = () => {
          restoreScrollPosition();
        };

        el.viewerFrame.src = url;

        if (state.newTabBlobUrl) {
          URL.revokeObjectURL(state.newTabBlobUrl);
        }
        state.newTabBlobUrl = URL.createObjectURL(record.file);

        el.openNewTabBtn.disabled = false;
        el.fullscreenBtn.disabled = false;
      } catch (e) {
        record.file.text().then(html => {
          el.viewerFrame.onload = () => {
            restoreScrollPosition();
          };
          el.viewerFrame.srcdoc = html;
          state.newTabBlobUrl = null;
          el.openNewTabBtn.disabled = true;
          el.fullscreenBtn.disabled = false;
        }).catch(err => {
          clearViewer();
          setStatus(`ËÆÄÂèñÊ™îÊ°àÂ§±ÊïóÔºö${err?.message || err}`, 'error');
        });
      }
    }

    function openActive() {
      if (state.activeIndex < 0 || state.activeIndex >= state.filtered.length) return;
      const r = state.filtered[state.activeIndex];
      openRecord(r);
      updateCurrentInfo();
      updateTopStatus();
    }

    function setActiveIndexFast(idx) {
      if (state.filtered.length === 0) return;
      state.activeIndex = ((idx % state.filtered.length) + state.filtered.length) % state.filtered.length;
      openActive();
    }

    function clearAll() {
      state.files = [];
      state.filtered = [];
      state.activeIndex = -1;
      state.folderDisplayName = "";
      state.tickerSelected = false;
      state.lastDirHandle = null;
      state.hasFolderSelected = false;
      state.scrollPosition = { x: 0, y: 0 };
      updateFolderDisplay();
      fillSelect(el.tickerSel, [], { placeholder: "-- Ë´ãÈÅ∏Êìá --" });
      fillSelect(el.dateSel, [], { placeholder: "-- ÈÅ∏Êìá --" });
      fillSelect(el.featureSel, [], { placeholder: "-- ÈÅ∏Êìá --" });
      el.rescanBtn.disabled = true;
      el.currentInfo.style.display = 'none';
      // Don't clear recentTickers HTML - keep showing them
      renderRecentTickers();
      clearViewer();
      setStatus('Ë´ãÂÖàÊåâ„ÄåÈÅ∏ÊìáË≥áÊñôÂ§æ„ÄçËºâÂÖ• HTML Â≠òÊ™î„ÄÇ', 'info');
      updatePageTitle(null);
    }

    // -----------------------------
    // Persistence
    // -----------------------------
    const idb = {
      db: null,
      async open() {
        if (this.db) return this.db;
        this.db = await new Promise((resolve, reject) => {
          const req = indexedDB.open('gex_viewer', 1);
          req.onupgradeneeded = () => {
            const db = req.result;
            if (!db.objectStoreNames.contains('kv')) db.createObjectStore('kv');
          };
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => reject(req.error);
        });
        return this.db;
      },
      async get(key) {
        const db = await this.open();
        return await new Promise((resolve, reject) => {
          const tx = db.transaction('kv', 'readonly');
          const store = tx.objectStore('kv');
          const req = store.get(key);
          req.onsuccess = () => resolve(req.result ?? null);
          req.onerror = () => reject(req.error);
        });
      },
      async set(key, val) {
        const db = await this.open();
        return await new Promise((resolve, reject) => {
          const tx = db.transaction('kv', 'readwrite');
          const store = tx.objectStore('kv');
          const req = store.put(val, key);
          req.onsuccess = () => resolve(true);
          req.onerror = () => reject(req.error);
        });
      },
    };

    async function canUseDirectoryHandle() {
      return typeof window.showDirectoryPicker === 'function' && typeof FileSystemDirectoryHandle !== 'undefined';
    }

    async function tryAutoReconnectOnLoad() {
      try {
        if (!(await canUseDirectoryHandle())) return;
        const saved = await idb.get('lastDirHandle');
        if (!saved) return;

        const perm = await saved.queryPermission?.({ mode: 'read' });
        state.folderDisplayName = saved.name || '';
        state.hasFolderSelected = true;
        updateFolderDisplay();

        if (perm === 'granted') {
          await scanDirectoryHandle(saved);
        } else {
          setStatus('Êåâ„ÄåÊõ¥ÊèõË≥áÊñôÂ§æ„ÄçÊàñ„ÄåÈáçÊñ∞ÊéÉÊèèÊñ∞Â¢ûÊ™îÊ°à„ÄçËºâÂÖ•„ÄÇ', 'info');
          state.lastDirHandle = saved;
          el.rescanBtn.disabled = false;
        }
      } catch {
        // ignore
      }
    }

    async function scanDirectoryHandle(dirHandle) {
      state.folderDisplayName = dirHandle?.name || '(Ë≥áÊñôÂ§æ)';
      state.hasFolderSelected = true;
      updateFolderDisplay();
      state.lastDirHandle = dirHandle;

      const records = [];
      let skipped = 0;
      let scannedCount = 0;

      el.scanProgress.style.display = 'block';
      el.scanProgressText.textContent = 'ÊéÉÊèè‰∏≠...';
      el.scanProgressFill.style.width = '0%';

      async function walk(handle, prefix) {
        for await (const entry of handle.values()) {
          if (entry.kind === 'directory') {
            await walk(entry, `${prefix}${entry.name}/`);
          } else if (entry.kind === 'file') {
            scannedCount++;
            if (scannedCount % 50 === 0) {
              el.scanProgressText.textContent = `Â∑≤ÊéÉÊèè ${scannedCount} ÂÄãÊ™îÊ°à...`;
              await new Promise(r => setTimeout(r, 0));
            }
            if (!entry.name.toLowerCase().endsWith('.html')) { skipped++; continue; }
            const file = await entry.getFile();
            const relPath = `${prefix}${entry.name}`;
            const rec = parseRecordFromFileLike({ file, relPath, name: entry.name });
            if (!rec) { skipped++; continue; }
            records.push(rec);
          }
        }
      }

      await walk(dirHandle, `${state.folderDisplayName}/`);

      el.scanProgress.style.display = 'none';

      if (records.length === 0) {
        setStatus('Êâæ‰∏çÂà∞Á¨¶ÂêàÂëΩÂêçË¶èÂâáÁöÑ .html„ÄÇÊ†ºÂºèÔºöyyyy-mm-dd_ÊôÇÈñì_ticker_ÂäüËÉΩ.html', 'error');
        return;
      }

      state.files = records.sort((a, b) => b.ts - a.ts || a.relPath.localeCompare(b.relPath));

      rebuildTickerSelector();
      rebuildDateAndFeatureSelectors();

      state.filtered = [];
      state.activeIndex = -1;
      state.tickerSelected = false;

      updateCurrentInfo();
      updateTopStatus();
      el.rescanBtn.disabled = false;

      setStatus(`Â∑≤ËºâÂÖ• ${state.files.length} ÂÄã HTML„ÄÇË´ãÈÅ∏Êìá Ticker„ÄÇ`, 'ok');
    }

    async function scanFiles(fileList) {
      const files = Array.from(fileList || []);
      if (files.length === 0) {
        setStatus('‰Ω†Ê≤íÊúâÈÅ∏Âà∞‰ªª‰ΩïÊ™îÊ°à„ÄÇ', 'error');
        return;
      }

      el.scanProgress.style.display = 'block';
      el.scanProgressText.textContent = 'ÊéÉÊèè‰∏≠...';
      el.scanProgressFill.style.width = '0%';

      const rp = files[0].webkitRelativePath || "";
      state.folderDisplayName = rp ? rp.split('/')[0] : "(Â∑≤ÈÅ∏Âèñ)";
      state.hasFolderSelected = true;
      updateFolderDisplay();
      state.lastDirHandle = null;

      const records = [];
      let skipped = 0;
      const total = files.length;

      for (let i = 0; i < files.length; i++) {
        const f = files[i];
        if (i % 50 === 0) {
          el.scanProgressText.textContent = `Â∑≤ÊéÉÊèè ${i}/${total} ÂÄãÊ™îÊ°à...`;
          el.scanProgressFill.style.width = `${Math.round(i / total * 100)}%`;
          await new Promise(r => setTimeout(r, 0));
        }
        if (!f.name.toLowerCase().endsWith('.html')) { skipped++; continue; }
        const relPath = f.webkitRelativePath || f.name;
        const rec = parseRecordFromFileLike({ file: f, relPath, name: f.name });
        if (!rec) { skipped++; continue; }
        records.push(rec);
      }

      el.scanProgress.style.display = 'none';

      if (records.length === 0) {
        setStatus('Êâæ‰∏çÂà∞Á¨¶ÂêàÂëΩÂêçË¶èÂâáÁöÑ .html„ÄÇÊ†ºÂºèÔºöyyyy-mm-dd_ÊôÇÈñì_ticker_ÂäüËÉΩ.html', 'error');
        return;
      }

      state.files = records.sort((a, b) => b.ts - a.ts || a.relPath.localeCompare(b.relPath));

      rebuildTickerSelector();
      rebuildDateAndFeatureSelectors();

      state.filtered = [];
      state.activeIndex = -1;
      state.tickerSelected = false;

      updateCurrentInfo();
      updateTopStatus();
      el.rescanBtn.disabled = true;

      setStatus(`Â∑≤ËºâÂÖ• ${state.files.length} ÂÄã HTML„ÄÇË´ãÈÅ∏Êìá Ticker„ÄÇ`, 'ok');
    }

    // -----------------------------
    // Events
    // -----------------------------
    el.pickFolderBtn.addEventListener('click', async () => {
      try {
        if (await canUseDirectoryHandle()) {
          const handle = await window.showDirectoryPicker({ mode: 'read' });
          try {
            await idb.set('lastDirHandle', handle);
          } catch {
            // ignore
          }
          await scanDirectoryHandle(handle);
          return;
        }
      } catch (e) {
        if (e.name !== 'AbortError') {
          setStatus('Ê≠§Áí∞Â¢ÉÁÑ°Ê≥ï‰ΩøÁî®„ÄåË®ò‰ΩèË≥áÊñôÂ§æ„ÄçÔºõÊîπÁî®Êú¨Ê©üÈÅ∏Âèñ„ÄÇ', 'info');
        } else {
          return;
        }
      }
      el.dirInput.click();
    });
    el.dirInput.addEventListener('change', (e) => scanFiles(e.target.files));

    el.rescanBtn.addEventListener('click', async () => {
      if (!state.lastDirHandle) {
        setStatus('Ê≤íÊúâÂèØÈáçÊñ∞ÊéÉÊèèÁöÑË≥áÊñôÂ§æ„ÄÇË´ãÂÖàÈÅ∏ÊìáË≥áÊñôÂ§æ„ÄÇ', 'error');
        return;
      }
      try {
        const perm = await state.lastDirHandle.requestPermission?.({ mode: 'read' });
        if (perm !== 'granted') {
          setStatus('Êú™ÊéàÊ¨äËÆÄÂèñË≥áÊñôÂ§æ„ÄÇ', 'error');
          return;
        }
        await scanDirectoryHandle(state.lastDirHandle);
      } catch (e) {
        setStatus(`ÈáçÊñ∞ÊéÉÊèèÂ§±ÊïóÔºö${e?.message || e}`, 'error');
      }
    });

    el.tickerSel.addEventListener('change', onTickerChange);
    el.dateSel.addEventListener('change', jumpToDate);
    el.featureSel.addEventListener('change', jumpToFeature);

    function setSidebarCollapsed(collapsed) {
      if (collapsed) document.body.classList.add('sidebarCollapsed');
      else document.body.classList.remove('sidebarCollapsed');
      el.toggleSidebarBtn.textContent = collapsed ? 'Â±ïÈñãÂÅ¥Ê¨Ñ' : 'Êî∂ÂêàÂÅ¥Ê¨Ñ';
    }

    el.collapseBtn.addEventListener('click', () => setSidebarCollapsed(true));
    el.toggleSidebarBtn.addEventListener('click', () => {
      const collapsed = document.body.classList.contains('sidebarCollapsed');
      setSidebarCollapsed(!collapsed);
    });

    el.fullscreenBtn.addEventListener('click', async () => {
      const target = document.getElementById('mainPanel');
      try {
        if (!document.fullscreenElement) await target.requestFullscreen();
        else await document.exitFullscreen();
      } catch (e) {
        setStatus(`ÂÖ®Ëû¢ÂπïÂ§±ÊïóÔºö${e?.message || e}`, 'error');
      }
    });

    el.openNewTabBtn.addEventListener('click', () => {
      if (!state.newTabBlobUrl) return;
      window.open(state.newTabBlobUrl, '_blank', 'noopener,noreferrer');
    });

    document.addEventListener('keydown', (e) => {
      if (isTypingContext()) return;
      if (!state.tickerSelected || state.filtered.length === 0) return;

      if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
        e.preventDefault();
        const dir = e.key === 'ArrowUp' ? -1 : 1;
        const nextIdx = (state.activeIndex + dir + state.filtered.length) % state.filtered.length;
        setActiveIndexFast(nextIdx);
        return;
      }

      if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
        e.preventDefault();
        const currRecord = state.filtered[state.activeIndex];
        if (!currRecord) return;

        const sameDateTime = state.filtered.filter(r => r.date === currRecord.date && r.time === currRecord.time);
        const features = Array.from(new Set(sameDateTime.map(r => r.feature))).sort((a, b) => a.localeCompare(b));
        if (features.length <= 1) return;

        const currFeatureIdx = features.indexOf(currRecord.feature);
        const dir = e.key === 'ArrowLeft' ? -1 : 1;
        const nextFeatureIdx = (currFeatureIdx + dir + features.length) % features.length;
        const nextFeature = features[nextFeatureIdx];

        const targetIdx = state.filtered.findIndex(r => 
          r.date === currRecord.date && r.time === currRecord.time && r.feature === nextFeature
        );
        if (targetIdx !== -1) {
          setActiveIndexFast(targetIdx);
        }
      }
    });

    // Init
    loadRecentTickers();
    clearAll();
    renderRecentTickers(); // Show recent tickers immediately
    tryAutoReconnectOnLoad();
  </script>
</body>
</html>
